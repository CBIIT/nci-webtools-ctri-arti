openapi: 3.1.0
info:
  title: CMS (Conversation Management Service) API
  description: |
    Internal service for managing agents, conversations, messages, tools, prompts,
    resources, and vectors. All routes are mounted under `/api/v1`.
    All requests must include an `X-User-Id` header. All data is scoped to the
    authenticated user, except global agents (userID=null) which are readable by all.
  version: 1.0.0

servers:
  - url: http://localhost:3002
    description: Local development

security:
  - userIdHeader: []

paths:
  # ===== AGENTS =====
  /api/v1/agents:
    post:
      operationId: createAgent
      summary: Create an agent
      tags: [Agents]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                description:
                  type: string
                promptID:
                  type: integer
                modelParameters:
                  type: object
      responses:
        "201":
          description: Agent created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "400":
          description: Missing X-User-Id header
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      operationId: getAgents
      summary: List agents
      description: Returns the user's agents plus global agents (userID=null), ordered by createdAt DESC.
      tags: [Agents]
      responses:
        "200":
          description: List of agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"

  /api/v1/agents/{id}:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    get:
      operationId: getAgent
      summary: Get agent by ID
      description: Returns agent with resolved Prompt. Flattens `Prompt.content` to `systemPrompt`. Resolves tools via AgentTool junction.
      tags: [Agents]
      responses:
        "200":
          description: Agent details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      operationId: updateAgent
      summary: Update an agent
      description: Only updates agents owned by the user. Returns 403 for global agents. Syncs AgentTool junction when `tools` array provided.
      tags: [Agents]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                promptID:
                  type: integer
                modelParameters:
                  type: object
                tools:
                  type: array
                  items:
                    type: string
                  description: Tool names to sync via AgentTool junction table
      responses:
        "200":
          description: Agent updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "403":
          description: Cannot modify global agent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Agent not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deleteAgent
      summary: Delete an agent
      description: Cascading delete — removes all conversations, messages, resources, and vectors.
      tags: [Agents]
      responses:
        "200":
          description: Agent deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"

  # ===== CONVERSATIONS =====
  /api/v1/conversations:
    post:
      operationId: createConversation
      summary: Create a conversation
      tags: [Conversations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                agentID:
                  type: integer
      responses:
        "201":
          description: Conversation created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conversation"
    get:
      operationId: getConversations
      summary: List conversations (paginated)
      description: Excludes soft-deleted conversations.
      tags: [Conversations]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Paginated conversation list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedConversations"

  /api/v1/conversations/{id}:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    get:
      operationId: getConversation
      summary: Get conversation by ID
      tags: [Conversations]
      responses:
        "200":
          description: Conversation details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conversation"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      operationId: updateConversation
      summary: Update a conversation
      tags: [Conversations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
      responses:
        "200":
          description: Conversation updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conversation"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deleteConversation
      summary: Delete a conversation
      description: Soft delete — sets `deleted: true` and `deletedAt`.
      tags: [Conversations]
      responses:
        "200":
          description: Conversation deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"

  /api/v1/conversations/{id}/context:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    get:
      operationId: getContext
      summary: Get conversation context
      description: Returns conversation with all messages and message-linked resources.
      tags: [Conversations]
      responses:
        "200":
          description: Conversation context
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversation:
                    $ref: "#/components/schemas/Conversation"
                  messages:
                    type: array
                    items:
                      $ref: "#/components/schemas/Message"
                  resources:
                    type: array
                    items:
                      $ref: "#/components/schemas/Resource"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/v1/conversations/{id}/compress:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    post:
      operationId: compressConversation
      summary: Compress a conversation
      description: Sets a summary message ID on the conversation for context windowing.
      tags: [Conversations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                summary:
                  type: string
                summaryMessageID:
                  type: integer
      responses:
        "200":
          description: Conversation compressed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Conversation"
        "404":
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ===== MESSAGES =====
  /api/v1/conversations/{conversationId}/messages:
    parameters:
      - name: conversationId
        in: path
        required: true
        schema:
          type: integer
    post:
      operationId: addMessage
      summary: Add a message to a conversation
      tags: [Messages]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role, content]
              properties:
                role:
                  type: string
                  enum: [user, assistant]
                content:
                  type: object
                  description: JSON content (text blocks, tool use, etc.)
                parentID:
                  type: integer
                  description: Parent message ID for threading
      responses:
        "201":
          description: Message created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"
    get:
      operationId: getMessages
      summary: Get all messages in a conversation
      description: Ordered by createdAt ASC.
      tags: [Messages]
      responses:
        "200":
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Message"

  /api/v1/messages/{id}:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    put:
      operationId: updateMessage
      summary: Update a message
      tags: [Messages]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: object
      responses:
        "200":
          description: Message updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Message"
        "404":
          description: Message not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deleteMessage
      summary: Delete a message
      tags: [Messages]
      responses:
        "200":
          description: Message deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"

  # ===== TOOLS =====
  /api/v1/tools:
    post:
      operationId: createTool
      summary: Create a tool
      tags: [Tools]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                type:
                  type: string
      responses:
        "201":
          description: Tool created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tool"
    get:
      operationId: getTools
      summary: List tools
      description: Returns builtin tools plus user's tools (via UserTool junction).
      tags: [Tools]
      responses:
        "200":
          description: List of tools
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Tool"

  /api/v1/tools/{id}:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    get:
      operationId: getTool
      summary: Get tool by ID
      tags: [Tools]
      responses:
        "200":
          description: Tool details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tool"
        "404":
          description: Tool not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      operationId: updateTool
      summary: Update a tool
      tags: [Tools]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Tool updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tool"
        "404":
          description: Tool not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deleteTool
      summary: Delete a tool
      description: Cascading delete — removes associated vectors, AgentTool, and UserTool records.
      tags: [Tools]
      responses:
        "200":
          description: Tool deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"

  /api/v1/tools/{id}/vectors:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    get:
      operationId: getToolVectors
      summary: Get vectors for a tool
      tags: [Tools]
      responses:
        "200":
          description: List of vectors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Vector"

  # ===== PROMPTS =====
  /api/v1/prompts:
    post:
      operationId: createPrompt
      summary: Create a prompt
      tags: [Prompts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, content]
              properties:
                name:
                  type: string
                content:
                  type: string
                version:
                  type: integer
      responses:
        "201":
          description: Prompt created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Prompt"
    get:
      operationId: getPrompts
      summary: List prompts
      description: Ordered by name ASC, version DESC.
      tags: [Prompts]
      responses:
        "200":
          description: List of prompts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Prompt"

  /api/v1/prompts/{id}:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    get:
      operationId: getPrompt
      summary: Get prompt by ID
      tags: [Prompts]
      responses:
        "200":
          description: Prompt details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Prompt"
        "404":
          description: Prompt not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      operationId: updatePrompt
      summary: Update a prompt
      tags: [Prompts]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Prompt updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Prompt"
        "404":
          description: Prompt not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deletePrompt
      summary: Delete a prompt
      tags: [Prompts]
      responses:
        "200":
          description: Prompt deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"

  # ===== RESOURCES =====
  /api/v1/resources:
    post:
      operationId: addResource
      summary: Create a resource
      tags: [Resources]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, type, content]
              properties:
                name:
                  type: string
                type:
                  type: string
                content:
                  type: string
                agentID:
                  type: integer
                messageID:
                  type: integer
                s3Uri:
                  type: string
                metadata:
                  type: object
      responses:
        "201":
          description: Resource created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Resource"

  /api/v1/resources/{id}:
    parameters:
      - $ref: "#/components/parameters/ResourceId"
    get:
      operationId: getResource
      summary: Get resource by ID
      tags: [Resources]
      responses:
        "200":
          description: Resource details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Resource"
        "404":
          description: Resource not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      operationId: deleteResource
      summary: Delete a resource
      description: Cascading delete — removes associated vectors.
      tags: [Resources]
      responses:
        "200":
          description: Resource deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"

  /api/v1/agents/{agentId}/resources:
    parameters:
      - name: agentId
        in: path
        required: true
        schema:
          type: integer
    get:
      operationId: getResourcesByAgent
      summary: Get resources for an agent
      description: Ordered by createdAt ASC.
      tags: [Resources]
      responses:
        "200":
          description: List of resources
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Resource"

  # ===== VECTORS =====
  /api/v1/vectors:
    post:
      operationId: addVectors
      summary: Add vectors
      description: Bulk create. Order defaults to array index.
      tags: [Vectors]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [vectors]
              properties:
                conversationID:
                  type: integer
                vectors:
                  type: array
                  items:
                    type: object
                    required: [content]
                    properties:
                      content:
                        type: string
                      embedding:
                        type: array
                        items:
                          type: number
                      resourceID:
                        type: integer
                      toolID:
                        type: integer
                      order:
                        type: integer
      responses:
        "201":
          description: Vectors created
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Vector"

  /api/v1/vectors/search:
    get:
      operationId: searchVectors
      summary: Search vectors by similarity
      description: Cosine similarity search when embedding is provided.
      tags: [Vectors]
      parameters:
        - name: toolID
          in: query
          schema:
            type: integer
        - name: conversationID
          in: query
          schema:
            type: integer
        - name: embedding
          in: query
          schema:
            type: string
          description: JSON-encoded embedding array
        - name: topN
          in: query
          schema:
            type: integer
            default: 10
      responses:
        "200":
          description: Matching vectors (with similarity score if embedding provided)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Vector"

  /api/v1/conversations/{conversationId}/vectors:
    parameters:
      - name: conversationId
        in: path
        required: true
        schema:
          type: integer
    get:
      operationId: getVectorsByConversation
      summary: Get vectors for a conversation
      description: Ordered by order ASC.
      tags: [Vectors]
      responses:
        "200":
          description: List of vectors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Vector"

  /health:
    get:
      operationId: healthCheck
      summary: Health check
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

components:
  securitySchemes:
    userIdHeader:
      type: apiKey
      in: header
      name: X-User-Id
      description: User ID for ownership scoping. Required on all endpoints except /health.

  parameters:
    ResourceId:
      name: id
      in: path
      required: true
      schema:
        type: integer

  schemas:
    Agent:
      type: object
      properties:
        id:
          type: integer
        userID:
          type: integer
          nullable: true
          description: "null for global agents"
        name:
          type: string
        description:
          type: string
        promptID:
          type: integer
        modelParameters:
          type: object
        tools:
          type: array
          items:
            type: string
          description: Tool names resolved from AgentTool junction (read-only)
        systemPrompt:
          type: string
          description: Flattened from Prompt.content (read-only)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Conversation:
      type: object
      properties:
        id:
          type: integer
        userID:
          type: integer
        agentID:
          type: integer
        title:
          type: string
        deleted:
          type: boolean
        deletedAt:
          type: string
          format: date-time
          nullable: true
        summaryMessageID:
          type: integer
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Message:
      type: object
      properties:
        id:
          type: integer
        conversationID:
          type: integer
        parentID:
          type: integer
          nullable: true
        role:
          type: string
          enum: [user, assistant]
        content:
          type: object
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Tool:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        type:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Prompt:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        content:
          type: string
        version:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Resource:
      type: object
      properties:
        id:
          type: integer
        agentID:
          type: integer
        messageID:
          type: integer
        name:
          type: string
        type:
          type: string
        content:
          type: string
        s3Uri:
          type: string
        metadata:
          type: object
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Vector:
      type: object
      properties:
        id:
          type: integer
        conversationID:
          type: integer
        resourceID:
          type: integer
        toolID:
          type: integer
        order:
          type: integer
        content:
          type: string
        embedding:
          type: array
          items:
            type: number
        similarity:
          type: number
          description: Cosine similarity score (only present in search results)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PaginatedConversations:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/Conversation"
        meta:
          type: object
          properties:
            total:
              type: integer
            limit:
              type: integer
            offset:
              type: integer

    Success:
      type: object
      properties:
        success:
          type: boolean
          example: true

    Error:
      type: object
      properties:
        error:
          type: string
